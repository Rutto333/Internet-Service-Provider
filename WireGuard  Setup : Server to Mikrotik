## Steps to Set Up WireGuard VPN Between Server and MikroTik Router

This guide walks you through setting up a WireGuard VPN between a generic Ubuntu/Debian server and a MikroTik router running RouterOS 7.x+. It also covers integrating PHPNuxBill to manage MikroTik via the VPN.

### Part 1: Server Setup (WireGuard Server)

#### Step 1: Install WireGuard on the Server

Update and upgrade your server:

```bash
sudo apt update && sudo apt upgrade -y
```

Install WireGuard and necessary tools:

```bash
sudo apt install wireguard qrencode iptables-persistent -y
```

#### Step 2: Generate Server Keys

Navigate to the WireGuard directory:

```bash
cd /etc/wireguard
```

Generate keys:

```bash
wg genkey | sudo tee server_private.key
sudo cat server_private.key | wg pubkey | sudo tee server_public.key
sudo chmod 600 server_private.key
```

#### Step 3: Configure WireGuard Server

Create the config file:

```bash
sudo nano /etc/wireguard/wg0.conf
```

Add the configuration:

```ini
[Interface]
PrivateKey = YOUR_SERVER_PRIVATE_KEY
Address = 10.0.0.1/24
ListenPort = 51820
SaveConfig = true

PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE

[Peer]
PublicKey = MIKROTIK_PUBLIC_KEY
AllowedIPs = 10.0.0.2/32, 192.168.1.0/24
```

#### Step 4: Enable IP Forwarding

```bash
echo 'net.ipv4.ip_forward=1' | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
```

#### Step 5: Configure Firewall

```bash
sudo ufw allow 51820/udp
sudo ufw allow ssh
sudo ufw enable
```

### Part 2: MikroTik Router Setup (WireGuard Client)

#### Step 1: Generate MikroTik Keys

```bash
/interface/wireguard
add name=wg-server listen-port=51820
```

#### Step 2: Add Server as Peer

```bash
/interface/wireguard/peers
add interface=wg-server public-key="SERVER_PUBLIC_KEY" endpoint-address=SERVER_IP endpoint-port=51820 allowed-address=0.0.0.0/0
```

#### Step 3: Configure IP and Routing

```bash
/ip/address
add address=10.0.0.2/24 interface=wg-server

/ip/route
add dst-address=0.0.0.0/0 gateway=10.0.0.1 distance=1
```

#### Step 4: Firewall and NAT Rules

```bash
/ip/firewall/filter
add chain=input action=accept connection-state=established,related
add chain=input action=accept protocol=udp dst-port=51820
add chain=input action=accept src-address=192.168.1.0/24

/ip/firewall/nat
add chain=srcnat action=masquerade out-interface=wg-server
```

### Part 3: Finalizing Server Configuration

#### Step 1: Add MikroTik Peer

Edit the config:

```bash
sudo nano /etc/wireguard/wg0.conf
```

Update the peer section with the MikroTik public key.

#### Step 2: Start WireGuard

```bash
sudo systemctl enable wg-quick@wg0
sudo systemctl start wg-quick@wg0
sudo systemctl status wg-quick@wg0
sudo wg show
```

### Part 4: PHPNuxBill Configuration

#### Step 1: Install PHPNuxBill

```bash
sudo apt install apache2 mysql-server php php-mysql php-cli php-curl php-json php-zip unzip -y

sudo mysql -u root -p
CREATE DATABASE nuxbill;
CREATE USER 'nuxbill'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON nuxbill.* TO 'nuxbill'@'localhost';
FLUSH PRIVILEGES;
EXIT;

cd /var/www/html
sudo wget https://github.com/hotspotbilling/phpnuxbill/archive/refs/heads/master.zip
sudo unzip master.zip
sudo mv phpnuxbill-master/* .
sudo chown -R www-data:www-data /var/www/html/
sudo chmod -R 755 /var/www/html/
```

#### Step 2: Web Configuration

1. Navigate to `http://SERVER_IP`
2. Follow the installer wizard
3. Configure database and admin credentials

#### Step 3: Add MikroTik Router

In PHPNuxBill:

* Router IP: 10.0.0.2
* API Port: 8728
* MikroTik Credentials

#### Step 4: Enable MikroTik API

```bash
/ip/service
set api disabled=no port=8728

/user
add name=api-user password=secure_password group=full
```

### Part 5: Testing and Troubleshooting

#### Step 1: Verify VPN Connection

On server:

```bash
sudo wg show
ping 10.0.0.2
```

On MikroTik:

```bash
/interface/wireguard/print
/ping 10.0.0.1
```

#### Step 2: Verify PHPNuxBill Connection

* Log in to PHPNuxBill
* Go to Settings → Router
* Test connection

#### Debug Commands

```bash
sudo wg show
sudo journalctl -u wg-quick@wg0
sudo iptables -L -n
```

```bash
/log print where topics~"wireguard"
/interface/wireguard/print detail
```

### Security Recommendations

* Change default WireGuard port
* Use strong API passwords
* Install fail2ban
* Apply updates regularly
* Monitor logs

### Network Topology

```
Internet
   ↓
[Server] ←→ WireGuard VPN ←→ [MikroTik Router]
10.0.0.1                         10.0.0.2
   ↓                               ↓
PHPNuxBill                 Local Network
                            192.168.1.0/24
```
